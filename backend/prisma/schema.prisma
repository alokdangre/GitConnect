// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ItemState {
  OPEN
  CLOSED
  MERGED
}

enum ReviewState {
  APPROVED
  COMMENTED
  CHANGES_REQUESTED
  DISMISSED
}

model User {
  id                   String       @id @default(uuid())
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  githubId             String       @unique
  login                String?
  name                 String?
  avatarUrl            String?
  bio                  String?
  email                String?
  profileUrl           String?
  followersCount       Int?
  followingCount       Int?
  personalAccessToken  String?
  tokenUpdatedAt       DateTime?
  tokenExpiresAt       DateTime?
  lastSyncedAt         DateTime?
  source               String?

  // relations
  repositories         Repository[]       // owner of repositories
  pullRequests         PullRequest[]      // authored PRs
  issues               Issue[]            // authored Issues
  commits              Commit[]           // authored Commits
  reviews              Review[]           // authored Reviews
  organizations        Organization[]     // implicit many-to-many with Organization

  @@index([githubId])
}

model Repository {
  id              String       @id @default(uuid())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  githubId        Int          @unique
  fullName        String
  name            String
  ownerLogin      String
  private         Boolean
  description     String?
  htmlUrl         String
  language        String?
  stars           Int?
  forks           Int?
  watchers        Int?
  size            Int?
  defaultBranch   String?
  license         String?
  topics          String[] 
  lastPushedAt    DateTime?
  state           String?

  // relations
  user            User?        @relation(fields: [userId], references: [id])
  userId          String?
  pullRequests    PullRequest[]
  issues          Issue[]
  commits         Commit[]
  reviews         Review[]
  organization    Organization? @relation(fields: [organizationId], references: [id])
  organizationId  String?

  llm_judge_response Json?
  rawData           Json?

  @@index([fullName])
  @@index([ownerLogin])
}

model PullRequest {
  id               String     @id @default(uuid())
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  githubNumber     Int
  title            String
  body             String?
  htmlUrl          String
  state            ItemState
  authorLogin      String?
  authorId         String?
  author           User?      @relation(fields: [authorId], references: [id])
  repository       Repository @relation(fields: [repositoryId], references: [id])
  repositoryId     String
  mergedAt         DateTime?
  closedAt         DateTime?
  additions        Int?
  deletions        Int?
  changedFiles     Int?
  commentsCount    Int?
  reviewCount      Int?

  // reverse relation for reviews on this PR
  reviews          Review[]

  llm_judge_response Json?
  llm_score        Float?
  llm_verdict      String?
  llm_summary      String?
  rawData          Json?
  syncedAt         DateTime?

  @@unique([repositoryId, githubNumber])
  @@index([authorId])
  @@index([repositoryId])
}

model Issue {
  id               String     @id @default(uuid())
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  githubNumber     Int
  title            String
  body             String?
  htmlUrl          String
  state            ItemState
  authorLogin      String?
  authorId         String?
  author           User?      @relation(fields: [authorId], references: [id])
  repository       Repository @relation(fields: [repositoryId], references: [id])
  repositoryId     String
  closedAt         DateTime?
  commentsCount    Int?
  labels           String[]
  assignees        String[]

  llm_judge_response Json?
  llm_score        Float?
  llm_verdict      String?
  rawData          Json?
  syncedAt         DateTime?

  @@unique([repositoryId, githubNumber])
  @@index([authorId])
  @@index([repositoryId])
}

model Commit {
  id               String     @id @default(uuid())
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  sha              String
  message          String
  htmlUrl          String
  authorName       String?
  authorEmail      String?
  authoredDate     DateTime?
  committedDate    DateTime?
  repository       Repository @relation(fields: [repositoryId], references: [id])
  repositoryId     String
  authorId         String?    // link to User if available
  author           User?      @relation(fields: [authorId], references: [id])
  additions        Int?
  deletions        Int?
  filesChanged     Int?
  commentsCount    Int?

  llm_judge_response Json?
  llm_score        Float?
  llm_verdict      String?
  rawData          Json?
  syncedAt         DateTime?

  @@unique([repositoryId, sha])
  @@index([repositoryId])
  @@index([sha])
}

model Review {
  id               String     @id @default(uuid())
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  githubId         Int        @unique
  reviewerLogin    String?
  reviewerId       String?
  reviewer         User?      @relation(fields: [reviewerId], references: [id])
  state            ReviewState
  body             String?
  submittedAt      DateTime?

  // relation to PR (required)
  pullRequest      PullRequest @relation(fields: [pullRequestId], references: [id])
  pullRequestId    String

  // relation to repository (so Repository.reviews has an opposite)
  repository       Repository  @relation(fields: [repositoryId], references: [id])
  repositoryId     String

  llm_judge_response Json?
  llm_score        Float?
  llm_verdict      String?
  rawData          Json?

  @@index([pullRequestId])
}

model Organization {
  id               String     @id @default(uuid())
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  githubId         Int?       @unique
  login            String
  name             String?
  description      String?
  htmlUrl          String?
  membersCount     Int?

  // relations
  repositories     Repository[]
  users            User[]        // implicit many-to-many with User

  llm_judge_response Json?
  rawData           Json?

  @@index([login])
}
