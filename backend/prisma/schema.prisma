// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ItemState {
  OPEN
  CLOSED
  MERGED
  REVERTED
}

enum ReviewState {
  APPROVED
  COMMENTED
  CHANGES_REQUESTED
  DISMISSED
}

model User {
  id                   String    @id @default(uuid())
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  githubId             String    @unique
  login                String?   // github login/username
  name                 String?
  avatarUrl            String?
  bio                  String?
  email                String?   // optional (may require scope)
  profileUrl           String?
  followersCount       Int?
  followingCount       Int?
  personalAccessToken  String?   // ENCRYPT or store reference to secrets manager
  tokenUpdatedAt       DateTime?
  tokenExpiresAt       DateTime?
  lastSyncedAt         DateTime? // when we last synced their GH data
  source               String?   // e.g. "github"
  repositories         Repository[] 
  pullRequests         PullRequest[]
  issues               Issue[]
  commits              Commit[]
  reviews              Review[]

  @@index([githubId])
}

model Repository {
  id              String    @id @default(uuid())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  githubId        Int       @unique        // GitHub repo id (numeric)
  fullName        String    // owner/name
  name            String
  ownerLogin      String
  private         Boolean
  description     String?
  htmlUrl         String
  language        String?
  stars           Int?
  forks           Int?
  watchers        Int?
  size            Int?
  defaultBranch   String?
  license         String?
  topics          String[]  // tags/topics
  lastPushedAt    DateTime?
  state           String?
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String?
  pullRequests    PullRequest[]
  issues          Issue[]
  commits         Commit[]
  reviews         Review[]
  llm_judge_response Json?
  rawData         Json?     // full GitHub repo payload for reprocessing

  @@index([fullName])
  @@index([ownerLogin])
}

model PullRequest {
  id               String    @id @default(uuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  githubNumber     Int       // PR number in the repo
  title            String
  body             String?
  htmlUrl          String
  state            ItemState
  authorLogin      String?   // author username (quick read)
  authorId         String?   // link to User if available
  author           User?     @relation(fields: [authorId], references: [id] , onDelete: Cascade)
  repository       Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  repositoryId     String
  mergedAt         DateTime?
  closedAt         DateTime?
  additions        Int?
  deletions        Int?
  changedFiles     Int?
  commentsCount    Int?
  reviewCount      Int?
  llm_judge_response Json?
  llm_score        Float?    // structured summary field
  llm_verdict      String?   // e.g., "good", "needs_work"
  rawData          Json?     // store full GH payload to re-evaluate
  syncedAt         DateTime?

  @@unique([repositoryId, githubNumber]) // prevents duplicate PRs for same repo
  @@index([authorId])
  @@index([repositoryId])
}

model Issue {
  id               String    @id @default(uuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  githubNumber     Int
  title            String
  body             String?
  htmlUrl          String
  state            ItemState
  authorLogin      String?
  authorId         String?
  author           User?     @relation(fields: [authorId], references: [id] , onDelete: Cascade)
  repository       Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  repositoryId     String
  closedAt         DateTime?
  commentsCount    Int?
  labels           String[]  // simple approach, or normalize to Label model
  assignees        String[]  // logins for quick reference
  llm_judge_response Json?
  llm_score        Float?
  llm_verdict      String?
  rawData          Json?
  syncedAt         DateTime?

  @@unique([repositoryId, githubNumber])
  @@index([authorId])
  @@index([repositoryId])
}

model Commit {
  id               String    @id @default(uuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  sha              String    // commit SHA (unique)
  message          String
  htmlUrl          String
  authorName       String?
  authorEmail      String?
  authoredDate     DateTime?
  committedDate    DateTime?
  repository       Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  repositoryId     String
  additions        Int?
  deletions        Int?
  filesChanged     Int?
  commentsCount    Int?
  llm_judge_response Json?
  llm_score        Float?
  llm_verdict      String?
  rawData          Json?
  syncedAt         DateTime?

  @@unique([repositoryId, sha])
  @@index([repositoryId])
  @@index([sha])
}

model Review {
  id               String    @id @default(uuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  githubId         Int       // GitHub review id
  pullRequest      PullRequest @relation(fields: [pullRequestId], references: [id], onDelete: Cascade)
  pullRequestId    String
  reviewerLogin    String?
  state            ReviewState
  body             String?
  submittedAt      DateTime?
  llm_judge_response Json?
  llm_score        Float?
  llm_verdict      String?
  rawData          Json?

  @@index([pullRequestId])
  @@unique([githubId])
}

model Organization {
  id               String    @id @default(uuid())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  githubId         Int?      @unique
  login            String
  name             String?
  description      String?
  htmlUrl          String?
  membersCount     Int?
  repositories     Repository[]
  users            User[]    // members (link via join table if you want many-to-many)
  llm_judge_response Json?
  rawData          Json?

  @@index([login])
}
